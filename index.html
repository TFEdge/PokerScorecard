<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Poker Game Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for better aesthetics */
        /* Applied only to the in-game list, where scrolling might be necessary for many players */
        .player-list::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .player-list::-webkit-scrollbar-thumb {
            background-color: #a8a8a8;
            border-radius: 10px;
        }
        /* Custom class for the sticky header effect */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #000; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* --- FIX for Screenshot Layout (Removing Scroll) --- */
        /* The main list container for players (in-game) can scroll, but we must ensure the payout table does not. */
        #payout-container {
            /* Removing overflow-x-auto from the element in HTML and ensuring its parent doesn't force a minimum width */
            overflow-x: hidden !important; 
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="max-w-6xl mx-auto">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Home Poker Scorecard ðŸ’°</h1>
            <p class="text-lg text-gray-600">Buy-in & Reloads are set to <span class="font-bold text-green-600">$10</span>.</p>
            <p id="user-id-display" class="text-sm text-gray-500 mt-2">Status: Data persists **PERMANENTLY** (Local Storage).</p>
        </header>

        <div id="status-message" class="mb-4 p-3 bg-blue-100 text-blue-700 rounded-lg hidden"></div>

        <div id="game-content-container">
        
            <div class="bg-white p-4 rounded-xl shadow-lg mb-8">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">Add New Player</h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-player-name" placeholder="Enter Player Name" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <button onclick="addPlayer()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 active:scale-95">
                        Add Player
                    </button>
                </div>
            </div>

            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Active Game Status (Buy-ins & Reloads)</h2>
            <div class="player-list overflow-x-auto mb-8">
                <div id="in-game-header" class="sticky-header grid grid-cols-[0.8fr_0.3fr_1.4fr_0.3fr] gap-1 font-bold text-sm text-white border-b-2 pb-2 mb-3 px-2 min-w-[400px]">
                    <div class="text-white">NAME</div> 
                    <div class="text-center text-yellow-400">BUY-IN ($)</div>
                    <div class="text-center text-blue-400">RELOADS / ADD</div>
                    <div class="text-center text-red-400">DEL</div>
                </div>
                
                <div id="in-game-list" class="space-y-3 pb-2">
                    <div class="text-center py-10 text-gray-500 bg-white rounded-xl shadow-md">No players added yet.</div>
                </div>
            </div>

            <h2 id="payout-title" class="text-2xl font-semibold mb-4 text-gray-700 border-t pt-4 border-gray-300">Payout & Final Results (Enter Closing Balances Here)</h2>
            
            <div id="payout-container" class="player-list"> 
                <div id="payout-header" class="sticky-header grid grid-cols-[0.8fr_0.9fr_0.9fr_1fr] gap-1 font-bold text-xs md:text-sm text-white border-b-2 pb-2 mb-3 px-2">
                    <div class="text-white">PLAYER</div>
                    <div class="text-center text-gray-400">TOTAL IN ($)</div>
                    <div class="text-right text-yellow-300">CLOSING BALANCE ($)</div>
                    <div class="text-right text-green-400">P/L (NET) ($)</div>
                </div>

                <div id="payout-list" class="space-y-3 pb-2">
                    <div class="text-center py-10 text-gray-500 bg-white rounded-xl shadow-md payout-list-item">No players added yet.</div>
                </div>
            </div>
            <div class="mt-8 pt-4 border-t border-gray-200 flex flex-col md:flex-row justify-end space-y-3 md:space-y-0 md:space-x-4">
                 <button onclick="showAdjustmentConfirmation()" id="adjust-shortfall-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 active:scale-95 disabled:opacity-50" disabled>
                    Adjust Shortfall/Surplus
                </button>
                <button onclick="showResetConfirmation()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 active:scale-95">
                    Reset Game Data
                </button>
            </div>
        </div>

    </div>

    <div id="reset-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden" onclick="hideModal('reset-modal')">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm mx-4" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-red-600">Confirm Reset</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to reset the game? This will clear all **Reloads**, **Closing Balances**, and **Adjustment Data** for every player, but their **Names** will remain.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('reset-modal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">Cancel</button>
                <button onclick="resetGame()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 active:scale-95">Reset Data</button>
            </div>
        </div>
    </div>
    
    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden" onclick="hideModal('delete-modal')">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm mx-4" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Remove Player</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to remove <strong id="delete-player-name" class="text-red-600"></strong> from the game?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('delete-modal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">Cancel</button>
                <button id="confirm-delete-button" onclick="" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 active:scale-95">Remove</button>
            </div>
        </div>
    </div>

    <div id="adjustment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden" onclick="hideModal('adjustment-modal')">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-indigo-600">Confirm Adjustment</h3>
            <p id="modal-explanation" class="text-gray-700 mb-6">
                </p>
            <p class="text-sm font-semibold text-gray-500 mb-4">
                This process is generally irreversible.
            </p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('adjustment-modal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">Cancel</button>
                <button onclick="adjustShortfallToWinners()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 active:scale-95">Confirm Adjustment</button>
            </div>
        </div>
    </div>

    <script>
        // Global state (In-Memory, but loaded/saved from Local Storage)
        let playersData = []; 
        let currentGameMetrics = { netProfitLoss: 0, totalMoneyIn: 0, totalClosingBalance: 0 }; 
        
        const BUY_IN_AMOUNT = 10;
        const LOCAL_STORAGE_KEY = 'pokerGamePersistentData'; 

        // --- Persistence Functions ---
        function loadSessionData() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    playersData = JSON.parse(storedData);
                    showStatus("Persistent data loaded successfully.", false);
                } else {
                    playersData = []; 
                }
            } catch (e) {
                console.error("Error loading session data:", e);
                showStatus("Error loading saved game data.", true);
                playersData = []; 
            }
        }
        
        function saveSessionData() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(playersData));
            } catch (e) {
                console.error("Error saving session data:", e);
                showStatus("Error saving game data. Is your browser storage full?", true);
            }
        }

        // --- Utility and Core Logic ---

        const showStatus = (message, isError = false) => {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-red-100', 'text-red-700');
            if (isError) {
                statusEl.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusEl.classList.add('bg-blue-100', 'text-blue-700');
            }
            statusEl.classList.remove('hidden');
            console.log(`STATUS: ${message}`);
        };

        const hideStatus = () => {
            document.getElementById('status-message').classList.add('hidden');
        };
        
        function calculateGameMetrics(players) {
            let totalInitialBuyIn = 0; 
            let totalReloadsCount = 0; 
            let totalClosingBalance = 0; 
            let totalMoneyIn = 0;
            
            const calculatedPlayers = players.map(player => {
                const playerReloads = player.reloads || 0;
                const playerAdjustment = player.adjustmentAmount || 0; 
                
                const totalPlayerMoneyIn = BUY_IN_AMOUNT + (playerReloads * BUY_IN_AMOUNT);
                const closingBalance = parseFloat(player.closingBalance) || 0;

                const profitLossAdjusted = closingBalance - totalPlayerMoneyIn; 
                const profitLossPre = (closingBalance - playerAdjustment) - totalPlayerMoneyIn;

                totalInitialBuyIn += BUY_IN_AMOUNT; 
                totalReloadsCount += playerReloads;
                totalClosingBalance += closingBalance;
                totalMoneyIn += totalPlayerMoneyIn;

                return {
                    ...player,
                    adjustmentAmount: playerAdjustment, 
                    totalPlayerMoneyIn: totalPlayerMoneyIn,
                    profitLossAdjusted: profitLossAdjusted,
                    profitLossPre: profitLossPre,
                    closingBalance: closingBalance 
                };
            });

            let netProfitLoss = totalClosingBalance - totalMoneyIn; 
            if (Math.abs(netProfitLoss) < 0.01) { netProfitLoss = 0.00; }
            
            currentGameMetrics = {
                netProfitLoss, 
                totalMoneyIn,
                totalClosingBalance,
                totalInitialBuyIn,
                totalReloadsCount
            };
            
            return calculatedPlayers;
        }

        // --- Core Logic: Process and Render ---
        function processAndRenderPlayers() {
            const calculatedPlayers = calculateGameMetrics(playersData);
            playersData = calculatedPlayers; 
            
            saveSessionData();
            
            renderInGameList(calculatedPlayers);
            renderSimplifiedPayoutTable(calculatedPlayers); 
            
            updateAdjustmentButtonState();
        }
        
        // Update the state of the adjustment button 
        function updateAdjustmentButtonState() {
            const btn = document.getElementById('adjust-shortfall-btn');
            const rawDifference = currentGameMetrics.netProfitLoss; 
            
            let isConditionMet = false;
            let amountToAdjust = 0;
            let buttonText = 'Adjust Shortfall/Surplus';

            if (rawDifference > 0.01) {
                isConditionMet = true;
                amountToAdjust = rawDifference;
                buttonText = `Apply Surplus Deduction (-$${amountToAdjust.toFixed(2)} PL Adj)`;
            } else if (rawDifference < -0.01) {
                 isConditionMet = true;
                 amountToAdjust = Math.abs(rawDifference);
                 buttonText = `Compensate Deficit (+$${amountToAdjust.toFixed(2)} PL Adj)`;
            }

            if (isConditionMet) {
                btn.removeAttribute('disabled');
            } else {
                btn.setAttribute('disabled', 'true');
            }
            btn.textContent = buttonText;
        }

        // Render In-Game List 
        function renderInGameList(players) {
            const inGameListEl = document.getElementById('in-game-list');
            inGameListEl.innerHTML = ''; 

            if (players.length === 0) {
                inGameListEl.innerHTML = '<div class="text-center py-10 text-gray-500 bg-white rounded-xl shadow-md">No players added yet.</div>';
                return;
            }

            players.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            const { totalInitialBuyIn, totalReloadsCount } = currentGameMetrics;
            
            let inGameListHTML = '';
            const inGameGridCols = 'grid-cols-[0.8fr_0.3fr_1.4fr_0.3fr]';
            const gapClass = 'gap-1'; 
            const paddingClass = 'p-2'; 

            players.forEach(player => {
                const playerReloads = player.reloads || 0;
                
                // IN-GAME STATUS ROW 
                inGameListHTML += `
                    <div class="player-row bg-white ${paddingClass} rounded-xl shadow-md grid ${inGameGridCols} ${gapClass} items-center min-w-[400px]">
                        <div class="flex items-center text-base font-semibold text-gray-800">
                            ${player.name}
                        </div>

                        <div class="text-center text-sm font-medium text-gray-600">
                            $${BUY_IN_AMOUNT}
                        </div>

                        <div class="flex items-center justify-center space-x-2">
                            <span class="text-base font-medium text-blue-600 w-5 text-right">${playerReloads}</span>
                            
                            <div class="flex items-center space-x-1">
                                <button 
                                    onclick="decrementReload('${player.id}')" 
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white w-7 h-7 rounded-lg shadow-md transition duration-200 active:scale-90 text-lg font-bold disabled:opacity-50"
                                    title="Subtract $${BUY_IN_AMOUNT} Reload"
                                    ${playerReloads > 0 ? '' : 'disabled'}
                                >
                                    -
                                </button>
                                <button 
                                    onclick="incrementReload('${player.id}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white w-7 h-7 rounded-lg shadow-md transition duration-200 active:scale-90 text-lg font-bold"
                                    title="Add $${BUY_IN_AMOUNT} Reload"
                                >
                                    +
                                </button>
                            </div>
                        </div>

                        <div class="flex justify-center items-center">
                            <button 
                                onclick="showDeleteConfirmation('${player.id}', '${player.name}')" 
                                class="bg-gray-200 hover:bg-red-300 text-gray-600 w-7 h-7 rounded-full shadow-md transition duration-200 active:scale-90 text-md"
                                title="Remove Player"
                            >
                                &times;
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // IN-GAME TOTALS
            const inGameTotalRowHTML = `
                <div class="player-row bg-gray-100 ${paddingClass} rounded-xl shadow-inner grid ${inGameGridCols} ${gapClass} items-center min-w-[400px] mt-4 border-t-2 border-gray-400">
                    <div class="text-base font-bold text-gray-800">TOTALS</div>
                    <div class="text-center text-sm font-bold text-gray-700">$${totalInitialBuyIn.toFixed(0)}</div>
                    <div class="text-center text-base font-bold text-blue-700">${totalReloadsCount}</div>
                    <div class="flex justify-center items-center text-gray-500">â€”</div>
                </div>
            `;
            inGameListEl.innerHTML = inGameListHTML + inGameTotalRowHTML;
        }

        // Render Simplified Payout Table (Default with Permanent Input)
        function renderSimplifiedPayoutTable(players) {
            
            const payoutListEl = document.getElementById('payout-list');
            payoutListEl.innerHTML = ''; 

            if (players.length === 0) {
                payoutListEl.innerHTML = '<div class="text-center py-10 text-gray-500 bg-white rounded-xl shadow-md payout-list-item">No players added yet.</div>';
                return;
            }

            players.sort((a, b) => b.profitLossAdjusted - a.profitLossAdjusted); // Sort by P/L Net
            
            const { totalMoneyIn, totalClosingBalance, netProfitLoss } = currentGameMetrics;
            
            let payoutListHTML = '';
            
            const payoutGridCols = 'grid-cols-[0.8fr_0.9fr_0.9fr_1fr]'; // Simplified grid
            const gapClass = 'gap-1'; 
            const paddingClass = 'p-2'; 

            players.forEach(player => {
                const totalPlayerMoneyIn = player.totalPlayerMoneyIn;
                const closingBalance = player.closingBalance;
                const profitLossAdjusted = player.profitLossAdjusted;
                const profitLossPre = player.profitLossPre; 

                // Determine profit/loss color for P/L Adj (Final)
                let profitLossAdjClass = 'text-gray-800';
                if (profitLossAdjusted > 0) {
                    profitLossAdjClass = 'text-green-600 font-bold';
                } else if (profitLossAdjusted < 0) {
                    profitLossAdjClass = 'text-red-600 font-bold';
                }
                
                const plAdjPrefix = profitLossAdjusted >= 0 ? '+' : '';

                // --- Adjustment Detail for P/L (Net) Column ---
                const adjValue = player.adjustmentAmount;
                let adjustmentDetailHTML = '';
                
                if (Math.abs(adjValue) > 0.01) { 
                    const plPrePrefix = profitLossPre >= 0 ? '+' : '';
                    const adjSign = adjValue >= 0 ? '+' : '';
                    
                    adjustmentDetailHTML = `
                        <span class="text-xs text-purple-600 font-semibold block leading-tight pt-0.5">
                            Pre: ${plPrePrefix}${Math.abs(profitLossPre).toFixed(2)} (${adjSign}${adjValue.toFixed(2)} Adj)
                        </span>
                    `;
                }
                // --- End Adjustment Detail ---
                
                // Balance Field: ALWAYS RENDER INPUT BOX
                let balanceFieldHTML = `
                    <div class="flex items-center">
                        <span class="mr-0.5 text-gray-500">$</span>
                        <input
                            type="number"
                            step="1"
                            min="0"
                            value="${closingBalance.toFixed(2)}"
                            onchange="updateClosingBalance('${player.id}', this.value)"
                            class="w-full p-1 border-2 border-yellow-300 rounded-lg text-right font-bold bg-yellow-50 text-base focus:ring-yellow-500 focus:border-yellow-500 transition duration-150 shadow-inner"
                        />
                    </div>
                `;

                // PAYOUT RESULTS ROW (SIMPLIFIED)
                payoutListHTML += `
                    <div class="player-row bg-white ${paddingClass} rounded-xl shadow-md grid ${payoutGridCols} ${gapClass} items-center payout-list-item">
                        <div class="flex items-center text-base font-semibold text-gray-800">
                            ${player.name}
                        </div>
                        
                        <div class="text-center text-sm font-medium text-gray-600">
                            $${totalPlayerMoneyIn.toFixed(2)}
                        </div>

                        ${balanceFieldHTML}

                        <div class="text-right font-extrabold">
                            <div class="${profitLossAdjClass}">
                                ${plAdjPrefix}$${Math.abs(profitLossAdjusted).toFixed(2)}
                                ${adjustmentDetailHTML}
                            </div>
                        </div>
                    </div>
                `;
            });

            // Total Logic 
            let shortfallDisplayPrefix;
            let shortfallDisplayValue;
            
            if (netProfitLoss < -0.01) {
                shortfallDisplayPrefix = '-';
                shortfallDisplayValue = Math.abs(netProfitLoss).toFixed(2);
                
            } else if (netProfitLoss > 0.01) {
                shortfallDisplayPrefix = '+';
                shortfallDisplayValue = netProfitLoss.toFixed(2);
                
            } else {
                shortfallDisplayPrefix = '+';
                shortfallDisplayValue = (0.00).toFixed(2);
            }
            
            const shortfallTotalClass = shortfallDisplayPrefix === '-' ? 'text-red-600 font-bold' : 'text-green-600 font-bold';

            // Add Totals Row
            const payoutTotalRowHTML = `
                <div class="player-row bg-gray-100 ${paddingClass} rounded-xl shadow-inner grid ${payoutGridCols} ${gapClass} items-center payout-list-item mt-4 border-t-2 border-gray-400">
                    <div class="text-base font-bold text-gray-800">TOTALS</div>
                    <div class="text-center text-sm font-bold text-gray-700">$${totalMoneyIn.toFixed(2)}</div>
                    <div class="text-right text-base font-bold text-gray-800">$${totalClosingBalance.toFixed(2)}</div>
                    
                    <div class="text-right text-base ${shortfallTotalClass}">${shortfallDisplayPrefix}$${shortfallDisplayValue}</div>
                </div>
            `;

            payoutListEl.innerHTML = payoutListHTML + payoutTotalRowHTML;
        }

        // --- CRUD Operations ---
        
        window.addPlayer = () => {
            const playerName = document.getElementById('new-player-name').value.trim();
            if (!playerName) {
                return showStatus("Please enter a player name.", false);
            }
            hideStatus();

            try {
                const newPlayer = {
                    id: crypto.randomUUID(), 
                    name: playerName,
                    reloads: 0,
                    closingBalance: 0, 
                    adjustmentAmount: 0,
                };
                playersData.push(newPlayer);
                document.getElementById('new-player-name').value = ''; 
                processAndRenderPlayers(); 
            } catch (e) {
                console.error("Error adding player: ", e);
                showStatus(`Failed to add player: ${e.message}`, true);
            }
        };

        function updatePlayerInArray(playerId, updates) {
            const index = playersData.findIndex(p => p.id === playerId);
            if (index !== -1) {
                playersData[index] = { ...playersData[index], ...updates };
                processAndRenderPlayers(); 
                return true;
            }
            return false;
        }

        window.incrementReload = (playerId) => {
            const player = playersData.find(p => p.id === playerId);
            if (player) {
                updatePlayerInArray(playerId, { reloads: player.reloads + 1 });
            }
        };

        window.decrementReload = (playerId) => {
            const player = playersData.find(p => p.id === playerId);
            if (player && player.reloads > 0) {
                updatePlayerInArray(playerId, { reloads: player.reloads - 1 });
            }
        };

        window.updateClosingBalance = (playerId, value) => {
            const numericValue = parseFloat(parseFloat(value).toFixed(2));
            if (isNaN(numericValue) || numericValue < 0) {
                console.warn("Invalid or negative closing balance entered. Reverting input state.");
                // Re-rendering will restore the valid previous state if input fails
                processAndRenderPlayers();
                return;
            }
            updatePlayerInArray(playerId, { 
                closingBalance: numericValue,
                adjustmentAmount: 0 
            });
        };

        // Adjustment functions
        window.showAdjustmentConfirmation = () => {
            const rawDifference = currentGameMetrics.netProfitLoss; 
            const modalTitleEl = document.getElementById('modal-title');
            const modalExplanationEl = document.getElementById('modal-explanation');

            if (rawDifference > 0.01) {
                modalTitleEl.textContent = "Confirm Surplus Deduction (Your Rule)";
                modalExplanationEl.innerHTML = `The net difference is a **SURPLUS** of <strong class="text-green-600">$${rawDifference.toFixed(2)}</strong> (Balance > Buy-ins). Per your rule, this will be applied as a <strong class="text-red-600">DEDUCTION</strong> (negative P&L Adj) to winning players' payouts.`;
                modalTitleEl.classList.add('text-red-600');
                modalTitleEl.classList.remove('text-indigo-600');
            } else if (rawDifference < -0.01) {
                modalTitleEl.textContent = "Confirm Deficit Compensation (Standard Shortfall)";
                modalExplanationEl.innerHTML = `The net difference is a **DEFICIT** of <strong class="text-red-600">$${Math.abs(rawDifference).toFixed(2)}</strong> (Balance < Buy-ins). This amount will be applied as an <strong class="text-indigo-600">ADDITION</strong> (positive P&L Adj) to winning players' payouts to balance the session.`;
                modalTitleEl.classList.add('text-indigo-600');
                modalTitleEl.classList.remove('text-red-600');
            } else {
                return showStatus("No significant difference detected. Adjustment not needed.", false);
            }
            
            document.getElementById('adjustment-modal').classList.remove('hidden');
        };

        window.adjustShortfallToWinners = () => {
            hideModal('adjustment-modal');

            const rawDifference = currentGameMetrics.netProfitLoss;
            
            if (Math.abs(rawDifference) < 0.01) {
                return showStatus("No significant difference to adjust.", true);
            }

            let adjustmentSign;
            let amountToDistribute = Math.abs(rawDifference);
            
            if (rawDifference > 0) {
                adjustmentSign = -1;
                showStatus(`Calculating and applying custom P/L deduction of $${amountToDistribute.toFixed(2)}...`);
            } else {
                adjustmentSign = 1;
                showStatus(`Calculating and applying standard shortfall compensation of $${amountToDistribute.toFixed(2)}...`);
            }
            
            const winnersPre = playersData.map(p => ({
                ...p,
                profitLossPreCheck: p.closingBalance - p.adjustmentAmount - p.totalPlayerMoneyIn
            })).filter(player => player.profitLossPreCheck > 0.01);
            
            if (winnersPre.length === 0) {
                return showStatus("Cannot adjust: No players had a profit (P/L > $0.01) to absorb/receive the adjustment.", true);
            }

            const totalWinnersGain = winnersPre.reduce((sum, player) => sum + player.profitLossPreCheck, 0);

            if (totalWinnersGain <= 0) {
                 return showStatus("Cannot adjust: Total winners' pre-adjustment gain is zero or negative.", true);
            }

            try {
                winnersPre.forEach(winner => {
                    const index = playersData.findIndex(p => p.id === winner.id);
                    if (index === -1) return; 
                    
                    const gainPercentage = winner.profitLossPreCheck / totalWinnersGain;
                    
                    const individualAdjustment = amountToDistribute * gainPercentage * adjustmentSign; 
                    
                    playersData[index].closingBalance = parseFloat((winner.closingBalance + individualAdjustment).toFixed(2));
                    playersData[index].adjustmentAmount = parseFloat((winner.adjustmentAmount + individualAdjustment).toFixed(2)); 
                });
                
                processAndRenderPlayers(); 
                
                showStatus(`Difference of $${amountToDistribute.toFixed(2)} successfully distributed to ${winnersPre.length} winners with a ${adjustmentSign === -1 ? 'DEDUCTION' : 'COMPENSATION'}.`, false);
                setTimeout(hideStatus, 5000);
            } catch (e) {
                console.error("Error adjusting shortfall:", e);
                showStatus(`Failed to apply adjustment: ${e.message}`, true);
            }
        };

        // Reset/Delete functions
        window.showResetConfirmation = () => {
            document.getElementById('reset-modal').classList.remove('hidden');
        };

        window.resetGame = () => {
            hideModal('reset-modal');
            showStatus("Resetting game data...");
            try {
                playersData = playersData.map(player => ({
                    ...player,
                    reloads: 0,
                    closingBalance: 0,
                    adjustmentAmount: 0
                }));
                
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                
                processAndRenderPlayers(); 
                showStatus("Game successfully reset!", false);
                setTimeout(hideStatus, 3000);
            } catch (e) {
                console.error("Error resetting data:", e);
                showStatus(`Failed to reset game: ${e.message}`, true);
            }
        };

        window.showDeleteConfirmation = (playerId, playerName) => {
            const modal = document.getElementById('delete-modal');
            document.getElementById('delete-player-name').textContent = playerName;
            
            const confirmButton = document.getElementById('confirm-delete-button');
            confirmButton.onclick = () => deletePlayer(playerId);
            
            modal.classList.remove('hidden');
        };

        window.deletePlayer = (playerId) => {
            hideModal('delete-modal');
            showStatus("Removing player...");

            try {
                playersData = playersData.filter(player => player.id !== playerId);
                processAndRenderPlayers(); 
                showStatus("Player successfully removed!", false);
                setTimeout(hideStatus, 3000);
            } catch (e) {
                console.error("Error deleting player:", e);
                showStatus(`Failed to remove player: ${e.message}`, true);
            }
        };

        window.hideModal = (id) => {
            document.getElementById(id).classList.add('hidden');
        };
        
        // Initial load: Load data from local storage first, then render
        window.onload = () => {
            loadSessionData();
            processAndRenderPlayers();
        };
    </script>
</body>
</html>
